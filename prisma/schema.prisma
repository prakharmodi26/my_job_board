generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           Int      @id @default(autoincrement())
  username     String   @unique
  passwordHash String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Profile {
  id                      Int      @id @default(autoincrement())

  // Core targeting
  targetTitles            String[] @default([])
  skills                  String[] @default([])
  preferredLocations      String[] @default([])
  remotePreferred         Boolean  @default(false)
  citizenshipNotRequired  Boolean  @default(true)

  // Role preferences
  seniority               String   @default("")
  yearsOfExperience       Int?
  roleTypes               String[] @default([])
  workModePreference      String   @default("")

  // Compensation
  minSalary               Int?
  maxSalary               Int?

  // Education
  education               String   @default("")
  degrees                 String[] @default([])

  // Industry & company
  industries              String[] @default([])
  companySizePreference   String   @default("")
  companyTypes            String[] @default([])

  updatedAt               DateTime @updatedAt
}

model Settings {
  id                      Int      @id @default(autoincrement())

  // Scoring weights
  weightSkillMatch        Int      @default(10)
  weightTargetTitle       Int      @default(10)
  weightRecencyDay1       Int      @default(30)
  weightRecencyDay3       Int      @default(20)
  weightRecencyWeek       Int      @default(10)
  weightRemoteMatch       Int      @default(15)
  weightWorkModeMatch     Int      @default(10)
  weightOnsiteMatch       Int      @default(5)
  weightSeniorityMatch    Int      @default(20)
  weightSeniorityMismatch Int      @default(-15)
  weightSalaryOverlap     Int      @default(15)
  weightSalaryBelow       Int      @default(-20)
  weightIndustryMatch     Int      @default(10)
  weightEducationMeet     Int      @default(5)
  weightEducationUnder    Int      @default(-10)
  weightCompanySize       Int      @default(10)
  weightExpMeet           Int      @default(10)
  weightExpClose          Int      @default(5)
  weightExpUnder          Int      @default(-15)
  weightCitizenship       Int      @default(-50)
  weightOptCptBoost       Int      @default(20)

  // Cron schedule (default: every 12 hours = 2x/day)
  cronSchedule            String   @default("0 */12 * * *")

  // Search settings (moved from Profile)
  searchNumPages          Int      @default(5)
  recommendedNumPages     Int      @default(3)
  recommendedDatePosted   String   @default("week")
  excludePublishers       String[] @default([])

  updatedAt               DateTime @updatedAt
}

model Job {
  id             Int      @id @default(autoincrement())
  source         String   @default("jsearch")
  sourceJobId    String?
  title          String
  company        String
  companyLogo    String?
  location       String
  city           String?
  state          String?
  country        String?
  isRemote       Boolean  @default(false)
  description    String
  applyUrl       String
  canonicalUrl   String?
  employmentType String?
  salaryMin      Float?
  salaryMax      Float?
  salaryPeriod   String?
  benefits       Json?
  highlights     Json?
  postedAt       DateTime?
  discoveredAt   DateTime @default(now())
  fingerprint    String?
  ignored        Boolean  @default(false)

  savedJobs         SavedJob[]
  recommendedMatches RecommendedMatch[]

  @@unique([source, sourceJobId])
  @@index([canonicalUrl])
  @@index([fingerprint])
  @@index([discoveredAt])
  @@index([ignored])
}

model SavedJob {
  id        Int      @id @default(autoincrement())
  jobId     Int      @unique
  status    String   @default("saved") // saved, applied, oa, interview, offer, rejected
  notes     String?
  appliedAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  job Job @relation(fields: [jobId], references: [id])

  @@index([status])
}

model RecommendedRun {
  id           Int      @id @default(autoincrement())
  runAt        DateTime @default(now())
  paramsJson   String?
  totalFetched Int      @default(0)
  newJobs      Int      @default(0)
  duplicates   Int      @default(0)
  status       String   @default("running") // running, completed, failed
  errorMessage String?

  matches RecommendedMatch[]

  @@index([runAt])
}

model RecommendedMatch {
  id    Int   @id @default(autoincrement())
  runId Int
  jobId Int
  score Float @default(0)
  rank  Int   @default(0)

  run RecommendedRun @relation(fields: [runId], references: [id])
  job Job            @relation(fields: [jobId], references: [id])

  @@unique([runId, jobId])
  @@index([runId, rank])
}
